CREATE PROCEDURE "AUTH_DB2_ZOS_REPORT"."USP_OBJECTPERM_DATA_2" (
  IN P_DB_CMDB_NAME VARCHAR(100),
  IN P_ZUST_ORG VARCHAR(50),
  IN P_SACHGEBIET VARCHAR(50),
  IN P_TIMESTAMP    VARCHAR(40),
  IN P_PREVTIMESTAMP VARCHAR(40),
  IN P_PERSONROLE VARCHAR(40),
  IN P_WHITELIST SMALLINT
) 
DYNAMIC RESULT SETS 1 
LANGUAGE SQL 
SPECIFIC USP_OBJECTPERM_DATA_2
BEGIN 
	DECLARE cur CURSOR WITH RETURN FOR 
WITH curr_global AS (

SELECT 	--DB_CMDB_NAME, 
		GRANTEE USERNAME, 
		sp.SNAP_TS,
	   	'DATABASE_USER' USERTYPE,
	   	roltab.RACFGRUPPE ROLENAME,
	   	'SELECT' PRIVILAGENAME, 
	   	'GRANT' ACCESSTYPE, 
	   	sp.TYPE TABLE_TYPE, 
	   	sp.TABSCHEMA SCHEMANAME, 
	   	sp.TABNAME OBJECTNAME, 
	   	'*' COLUMNNAME
FROM AUTH_DB2_ZOS_REPORT.VW_REPORT_DB2_ZOS_TABAUTH  sp
LEFT JOIN AUTH_DB2_ZOS_REPORT.VW_REPORT_DB2_ZOS_TAREZUDBTABAUTH roltab
 		ON roltab.TBCREATOR=sp.GRANTEE
 			AND TRIM(sp.zust_orga)=TRIM(roltab.ZUST_orga)
 			AND TRIM(sp.sachgebiet)=TRIM(roltab.sachgebiet)
WHERE TRIM(sp.SYSPLEX_CMDB_NAME)=TRIM(P_DB_CMDB_NAME) 
		AND TRIM(sp.zust_orga)=TRIM(P_ZUST_ORG) 
		AND TRIM(sp.sachgebiet)=TRIM(P_SACHGEBIET) 
		AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS')=TRIM(P_TIMESTAMP)
		AND TRIM(P_PERSONROLE) !='DataSteward' 
     	AND sp.SELECTAUTH is not null
UNION ALL 
SELECT 	--DB_CMDB_NAME, 
		GRANTEE USERNAME, 
		sp.SNAP_TS,
	   	'DATABASE_USER' USERTYPE, 
	   	roltab.RACFGRUPPE ROLENAME,
	   	'INSERT' PRIVILAGENAME, 
	   	'GRANT' ACCESSTYPE, 
	   	sp.TYPE TABLE_TYPE, 
	   	sp.TABSCHEMA SCHEMANAME, 
	   	sp.TABNAME OBJECTNAME, 
	   	'*' COLUMNNAME
FROM AUTH_DB2_ZOS_REPORT.VW_REPORT_DB2_ZOS_TABAUTH  sp
LEFT JOIN AUTH_DB2_ZOS_REPORT.VW_REPORT_DB2_ZOS_TAREZUDBTABAUTH roltab
 		ON roltab.TBCREATOR=sp.GRANTEE
 			AND TRIM(sp.zust_orga)=TRIM(roltab.ZUST_orga)
 			AND TRIM(sp.sachgebiet)=TRIM(roltab.sachgebiet)
WHERE TRIM(sp.SYSPLEX_CMDB_NAME)=TRIM(P_DB_CMDB_NAME) 
		AND TRIM(sp.zust_orga)=TRIM(P_ZUST_ORG) 
		AND TRIM(sp.sachgebiet)=TRIM(P_SACHGEBIET) 
		AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS')=TRIM(P_TIMESTAMP)
		AND TRIM(P_PERSONROLE) !='DataSteward' 
     	AND sp.INSERTAUTH is not null
UNION ALL 
SELECT 	--DB_CMDB_NAME, 
		GRANTEE USERNAME, 
		sp.SNAP_TS,
	   	'DATABASE_USER' USERTYPE, 	 
	   	roltab.RACFGRUPPE ROLENAME,
	   	'UPDATE' PRIVILAGENAME, 
	   	'GRANT' ACCESSTYPE, 
	   	sp.TYPE TABLE_TYPE, 
	   	sp.TABSCHEMA SCHEMANAME, 
	   	sp.TABNAME OBJECTNAME, 
	   	'*' COLUMNNAME
FROM AUTH_DB2_ZOS_REPORT.VW_REPORT_DB2_ZOS_TABAUTH  sp
LEFT JOIN AUTH_DB2_ZOS_REPORT.VW_REPORT_DB2_ZOS_TAREZUDBTABAUTH roltab
 		ON roltab.TBCREATOR=sp.GRANTEE
 			AND TRIM(sp.zust_orga)=TRIM(roltab.ZUST_orga)
 			AND TRIM(sp.sachgebiet)=TRIM(roltab.sachgebiet)
WHERE TRIM(sp.SYSPLEX_CMDB_NAME)=TRIM(P_DB_CMDB_NAME) 
		AND TRIM(sp.zust_orga)=TRIM(P_ZUST_ORG) 
		AND TRIM(sp.sachgebiet)=TRIM(P_SACHGEBIET) 
		AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS')=TRIM(P_TIMESTAMP)
		AND TRIM(P_PERSONROLE) !='DataSteward' 
     	AND sp.UPDATEAUTH is not null
UNION ALL 
SELECT 	--DB_CMDB_NAME, 
		GRANTEE USERNAME, 
		sp.SNAP_TS,
	   	'DATABASE_USER' USERTYPE,
	   	roltab.RACFGRUPPE ROLENAME,
	   	'DELETE' PRIVILAGENAME,
	   	'GRANT' ACCESSTYPE, 
	   	sp.TYPE TABLE_TYPE, 
	   	sp.TABSCHEMA SCHEMANAME, 
	   	sp.TABNAME OBJECTNAME, 
	   	'*' COLUMNNAME
FROM AUTH_DB2_ZOS_REPORT.VW_REPORT_DB2_ZOS_TABAUTH  sp
LEFT JOIN AUTH_DB2_ZOS_REPORT.VW_REPORT_DB2_ZOS_TAREZUDBTABAUTH roltab
 		ON roltab.TBCREATOR=sp.GRANTEE
 			AND TRIM(sp.zust_orga)=TRIM(roltab.ZUST_orga)
 			AND TRIM(sp.sachgebiet)=TRIM(roltab.sachgebiet)
WHERE TRIM(sp.SYSPLEX_CMDB_NAME)=TRIM(P_DB_CMDB_NAME) 
		AND TRIM(sp.zust_orga)=TRIM(P_ZUST_ORG) 
		AND TRIM(sp.sachgebiet)=TRIM(P_SACHGEBIET) 
		AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS')=TRIM(P_TIMESTAMP) 
		AND TRIM(P_PERSONROLE) !='DataSteward'  
     	AND sp.DELETEAUTH is not null
),
prev_global AS (

SELECT 	--DB_CMDB_NAME, 
		GRANTEE USERNAME, 
		sp.SNAP_TS,
	   	'DATABASE_USER' USERTYPE,
	   	roltab.RACFGRUPPE ROLENAME,
	   	'SELECT' PRIVILAGENAME, 
	   	'GRANT' ACCESSTYPE, 
	   	sp.TYPE TABLE_TYPE, 
	   	sp.TABSCHEMA SCHEMANAME, 
	   	sp.TABNAME OBJECTNAME, 
	   	'*' COLUMNNAME
FROM AUTH_DB2_ZOS_REPORT.VW_REPORT_DB2_ZOS_TABAUTH  sp
LEFT JOIN AUTH_DB2_ZOS_REPORT.VW_REPORT_DB2_ZOS_TAREZUDBTABAUTH roltab
 		ON roltab.TBCREATOR=sp.GRANTEE
 			AND TRIM(sp.zust_orga)=TRIM(roltab.ZUST_orga)
 			AND TRIM(sp.sachgebiet)=TRIM(roltab.sachgebiet)
WHERE TRIM(sp.SYSPLEX_CMDB_NAME)=TRIM(P_DB_CMDB_NAME) 
		AND TRIM(sp.zust_orga)=TRIM(P_ZUST_ORG) 
		AND TRIM(sp.sachgebiet)=TRIM(P_SACHGEBIET) 
		AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS')=TRIM(P_PREVTIMESTAMP)
		AND TRIM(P_PERSONROLE) !='DataSteward' 
     	AND sp.SELECTAUTH is not null
UNION ALL 
SELECT 	--DB_CMDB_NAME, 
		GRANTEE USERNAME, 
		sp.SNAP_TS,
	   	'DATABASE_USER' USERTYPE, 
	   	roltab.RACFGRUPPE ROLENAME,
	   	'INSERT' PRIVILAGENAME, 
	   	'GRANT' ACCESSTYPE, 
	   	sp.TYPE TABLE_TYPE, 
	   	sp.TABSCHEMA SCHEMANAME, 
	   	sp.TABNAME OBJECTNAME, 
	   	'*' COLUMNNAME
FROM AUTH_DB2_ZOS_REPORT.VW_REPORT_DB2_ZOS_TABAUTH  sp
LEFT JOIN AUTH_DB2_ZOS_REPORT.VW_REPORT_DB2_ZOS_TAREZUDBTABAUTH roltab
 		ON roltab.TBCREATOR=sp.GRANTEE
 			AND TRIM(sp.zust_orga)=TRIM(roltab.ZUST_orga)
 			AND TRIM(sp.sachgebiet)=TRIM(roltab.sachgebiet)
WHERE TRIM(sp.SYSPLEX_CMDB_NAME)=TRIM(P_DB_CMDB_NAME) 
		AND TRIM(sp.zust_orga)=TRIM(P_ZUST_ORG) 
		AND TRIM(sp.sachgebiet)=TRIM(P_SACHGEBIET) 
		AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS')=TRIM(P_PREVTIMESTAMP)
		AND TRIM(P_PERSONROLE) !='DataSteward' 
     	AND sp.INSERTAUTH is not null
UNION ALL 
SELECT 	--DB_CMDB_NAME, 
		GRANTEE USERNAME, 
		sp.SNAP_TS,
	   	'DATABASE_USER' USERTYPE, 	 
	   	roltab.RACFGRUPPE ROLENAME,
	   	'UPDATE' PRIVILAGENAME, 
	   	'GRANT' ACCESSTYPE, 
	   	sp.TYPE TABLE_TYPE, 
	   	sp.TABSCHEMA SCHEMANAME, 
	   	sp.TABNAME OBJECTNAME, 
	   	'*' COLUMNNAME
FROM AUTH_DB2_ZOS_REPORT.VW_REPORT_DB2_ZOS_TABAUTH  sp
LEFT JOIN AUTH_DB2_ZOS_REPORT.VW_REPORT_DB2_ZOS_TAREZUDBTABAUTH roltab
 		ON roltab.TBCREATOR=sp.GRANTEE
 			AND TRIM(sp.zust_orga)=TRIM(roltab.ZUST_orga)
 			AND TRIM(sp.sachgebiet)=TRIM(roltab.sachgebiet)
WHERE TRIM(sp.SYSPLEX_CMDB_NAME)=TRIM(P_DB_CMDB_NAME) 
		AND TRIM(sp.zust_orga)=TRIM(P_ZUST_ORG) 
		AND TRIM(sp.sachgebiet)=TRIM(P_SACHGEBIET) 
		AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS')=TRIM(P_PREVTIMESTAMP)
		AND TRIM(P_PERSONROLE) !='DataSteward' 
     	AND sp.UPDATEAUTH is not null
UNION ALL 
SELECT 	--DB_CMDB_NAME, 
		GRANTEE USERNAME, 
		sp.SNAP_TS,
	   	'DATABASE_USER' USERTYPE,
	   	roltab.RACFGRUPPE ROLENAME,
	   	'DELETE' PRIVILAGENAME, 
	   	'GRANT' ACCESSTYPE, 
	   	sp.TYPE TABLE_TYPE, 
	   	sp.TABSCHEMA SCHEMANAME, 
	   	sp.TABNAME OBJECTNAME, 
	   	'*' COLUMNNAME
FROM AUTH_DB2_ZOS_REPORT.VW_REPORT_DB2_ZOS_TABAUTH  sp
LEFT JOIN AUTH_DB2_ZOS_REPORT.VW_REPORT_DB2_ZOS_TAREZUDBTABAUTH roltab
 		ON roltab.TBCREATOR=sp.GRANTEE
 			AND TRIM(sp.zust_orga)=TRIM(roltab.ZUST_orga)
 			AND TRIM(sp.sachgebiet)=TRIM(roltab.sachgebiet)
WHERE TRIM(sp.SYSPLEX_CMDB_NAME)=TRIM(P_DB_CMDB_NAME) 
		AND TRIM(sp.zust_orga)=TRIM(P_ZUST_ORG) 
		AND TRIM(sp.sachgebiet)=TRIM(P_SACHGEBIET) 
		AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS')=TRIM(P_PREVTIMESTAMP)  
		AND TRIM(P_PERSONROLE) !='DataSteward' 
     	AND sp.DELETEAUTH is not null
)
SELECT DISTINCT 
            'Object permission' Global, 
            ISNULL(curr.USERNAME, prev.USERNAME)			            	as username, 
            ISNULL(curr.ROLENAME, prev.ROLENAME)							as rolename,
            ISNULL(curr.SCHEMANAME, prev.SCHEMANAME)						as schemaname,
            CASE ISNULL(curr.TABLE_TYPE, prev.TABLE_TYPE)	
            			WHEN 'T' 			THEN 'TABLE'
						WHEN 'H'			THEN 'HISTORY_TABLE'
						WHEN 'V'			THEN 'VIEW'
						WHEN 'M'			THEN 'MQT'
						WHEN 'R'			THEN 'SYNONYM'			    	
            ELSE ISNULL(curr.TABLE_TYPE, prev.TABLE_TYPE) END as table_type,		
            case ISNULL(curr.USERTYPE, prev.USERTYPE)	when 'U' then 'DATABASE_USER'
                                                    	when 'R' then 'DATABASE_ROLE'
            else ISNULL(curr.USERTYPE, prev.USERTYPE) end              	as usertype,
            ISNULL(curr.ACCESSTYPE, prev.ACCESSTYPE)						as AccessType,
            ISNULL(curr.PRIVILAGENAME, prev.PRIVILAGENAME)		    		as Privilege,
            ISNULL(curr.OBJECTNAME, prev.OBJECTNAME)				    	as Objectname,
            ISNULL(curr.COLUMNNAME, prev.COLUMNNAME)						as ColumnName,
            case when curr.PRIVILAGENAME is null and prev.PRIVILAGENAME is not null then 'DEL'
                 when prev.PRIVILAGENAME is null and curr.PRIVILAGENAME is not null then 'NEW'
            else 'SAME' end sign_compare
        FROM curr_global curr
        FULL OUTER JOIN prev_global prev 
            ON ISNULL(prev.USERNAME,'')=ISNULL(curr.USERNAME,'') 
            	AND ISNULL(prev.ROLENAME,'')=ISNULL(curr.ROLENAME,'') 
            	AND ISNULL(prev.SCHEMANAME,'')=ISNULL(curr.SCHEMANAME,'') 
            	AND ISNULL(prev.TABLE_TYPE,'')=ISNULL(curr.TABLE_TYPE,'') 
            	AND ISNULL(prev.OBJECTNAME,'')=ISNULL(curr.OBJECTNAME,'')
            	AND ISNULL(prev.COLUMNNAME,'')=ISNULL(curr.COLUMNNAME,'')
            	AND ISNULL(prev.USERTYPE,'')=ISNULL(curr.USERTYPE,'') 
            	and ISNULL(prev.ACCESSTYPE,'')=ISNULL(curr.ACCESSTYPE,'') 
            	and ISNULL(prev.PRIVILAGENAME,'')=ISNULL(curr.PRIVILAGENAME,'')
        WHERE curr.PRIVILAGENAME is not null --without DELETED permission
		AND (ISNULL(P_WHITELIST,0)=0
                OR (not exists (select 1 from AUTH_DB2_LUW_REPORT.VW_DB2_LUW_ADMINS where USERID = ISNULL(curr.USERNAME, prev.USERNAME) ))
            )
        ORDER BY sign_compare, --strFullInstanceName, 
        username, rolename, table_type, AccessType, Privilege, schemaname, Objectname, ColumnName;

  OPEN cur;

END