CREATE PROCEDURE "AUTH_DB2_ZOS_REPORT"."USP_OBJECTPERM_DATA_1" (
  IN P_DB_CMDB_NAME VARCHAR(100),
  IN P_ZUST_ORG VARCHAR(50),
  IN P_SACHGEBIET VARCHAR(50),
  IN P_TIMESTAMP    VARCHAR(40),
  IN P_PREVTIMESTAMP VARCHAR(40),
  IN P_PERSONROLE VARCHAR(40),
  IN P_WHITELIST SMALLINT
) 
DYNAMIC RESULT SETS 1 
LANGUAGE SQL 
SPECIFIC USP_OBJECTPERM_DATA
BEGIN 
	DECLARE cur CURSOR WITH RETURN FOR 
	WITH curr_global AS (
  
	SELECT DISTINCT 'Object permission'	Global,
		tab.GRANTEE USERNAME, 
		'DATABASE_USER' USERTYPE,
		roltab.RACFGRUPPE ROLENAME,
		'GRANT' ACCESSTYPE,
		CASE 	WHEN tab.selectauth='Y' THEN 'YES'
				ELSE NULL
		END SELECTAUTH,
		CASE	WHEN tab.insertauth='Y' THEN 'YES'
				ELSE NULL
		END INSERTAUTH,
		CASE	WHEN tab.updateauth='Y' THEN 'YES'
				ELSE NULL
		END UPDATEAUTH,
		CASE	WHEN tab.deleteauth='Y' THEN 'YES'
				ELSE NULL
		END DELETEAUTH,
		CASE tab.TYPE 	WHEN 'T' 			THEN 'TABLE'
						WHEN 'H'			THEN 'HISTORY_TABLE'
						WHEN 'V'			THEN 'VIEW'
						WHEN 'M'			THEN 'MQT'
						WHEN 'R'			THEN 'SYNONYM'
						ELSE NULL
		END TABLE_TYPE,
		tab.TABSCHEMA SCHEMANAME,
		tab.TABNAME OBJECTNAME,
		'*' COLUMNNAME
 	FROM AUTH_DB2_ZOS_REPORT.VW_REPORT_DB2_ZOS_TABAUTH tab
 	LEFT JOIN AUTH_DB2_ZOS_REPORT.VW_REPORT_DB2_ZOS_TAREZUDBTABAUTH roltab
 		ON roltab.TBCREATOR=tab.GRANTEE
 			AND TRIM(tab.zust_orga)=TRIM(roltab.ZUST_orga)
 			AND TRIM(tab.sachgebiet)=TRIM(roltab.sachgebiet)
	WHERE TRIM(tab.SYSPLEX_CMDB_NAME)=TRIM(P_DB_CMDB_NAME) 
		AND TRIM(tab.zust_orga)=TRIM(P_ZUST_ORG) 
		AND TRIM(tab.sachgebiet)=TRIM(P_SACHGEBIET)
		AND VARCHAR_FORMAT(tab.SNAP_TS,'DD.MM.YYYY HH24:MI:SS')=TRIM(P_TIMESTAMP)
		AND P_PERSONROLE != 'DataSteward'	
  	
	),
	prev_global AS (
	SELECT DISTINCT 'Object permission'	Global,
		tab.GRANTEE USERNAME, 
		'DATABASE_USER' USERTYPE,
		roltab.RACFGRUPPE ROLENAME,
		'GRANT' ACCESSTYPE,
		CASE 	WHEN tab.selectauth='Y' THEN 'YES'
				ELSE NULL
		END SELECTAUTH,
		CASE	WHEN tab.insertauth='Y' THEN 'YES'
				ELSE NULL
		END INSERTAUTH,
		CASE	WHEN tab.updateauth='Y' THEN 'YES'
				ELSE NULL
		END UPDATEAUTH,
		CASE	WHEN tab.deleteauth='Y' THEN 'YES'
				ELSE NULL
		END DELETEAUTH,
		CASE tab.TYPE 	WHEN 'T' 			THEN 'TABLE'
						WHEN 'H'			THEN 'HISTORY_TABLE'
						WHEN 'V'			THEN 'VIEW'
						WHEN 'M'			THEN 'MQT'
						WHEN 'R'			THEN 'SYNONYM'
						ELSE NULL
		END TABLE_TYPE,
		tab.TABSCHEMA SCHEMANAME,
		tab.TABNAME OBJECTNAME,
		'*' COLUMNNAME
 	FROM AUTH_DB2_ZOS_REPORT.VW_REPORT_DB2_ZOS_TABAUTH tab
 	LEFT JOIN AUTH_DB2_ZOS_REPORT.VW_REPORT_DB2_ZOS_TAREZUDBTABAUTH roltab
 		ON roltab.TBCREATOR=tab.GRANTEE
 			AND TRIM(tab.zust_orga)=TRIM(roltab.ZUST_orga)
 			AND TRIM(tab.sachgebiet)=TRIM(roltab.sachgebiet)
	WHERE TRIM(tab.SYSPLEX_CMDB_NAME)=TRIM(P_DB_CMDB_NAME) 
		AND TRIM(tab.zust_orga)=TRIM(P_ZUST_ORG) 
		AND TRIM(tab.sachgebiet)=TRIM(P_SACHGEBIET)
		AND VARCHAR_FORMAT(tab.SNAP_TS,'DD.MM.YYYY HH24:MI:SS')=TRIM(P_PREVTIMESTAMP)
		AND P_PERSONROLE != 'DataSteward'	
  	
	)
	
	SELECT DISTINCT 
            'Object permission' Global, 
            ISNULL(curr.USERNAME, prev.USERNAME)			            	as username, 
            ISNULL(curr.ROLENAME, prev.ROLENAME)							as rolename,
            ISNULL(curr.SCHEMANAME, prev.SCHEMANAME)						as schemaname,
            ISNULL(curr.TABLE_TYPE, prev.TABLE_TYPE)				    	as table_type,		
            case ISNULL(curr.USERTYPE, prev.USERTYPE)	when 'U' then 'DATABASE_USER'
                                                    	when 'R' then 'DATABASE_ROLE'
            else ISNULL(curr.USERTYPE, prev.USERTYPE) end              	as usertype,
            ISNULL(curr.ACCESSTYPE, prev.ACCESSTYPE)						as AccessType,
            --ISNULL(curr.PRIVILAGENAME, prev.PRIVILAGENAME)		    		as Privilege,
            ISNULL(curr.SELECTAUTH, prev.SELECTAUTH)						as SELECT,
            ISNULL(curr.INSERTAUTH, prev.INSERTAUTH)						as INSERT,
            ISNULL(curr.UPDATEAUTH, prev.UPDATEAUTH)						as UPDATE,
            ISNULL(curr.DELETEAUTH, prev.DELETEAUTH)						as DELETE,
            ISNULL(curr.OBJECTNAME, prev.OBJECTNAME)				    	as Objectname,
            ISNULL(curr.COLUMNNAME, prev.COLUMNNAME)						as ColumnName,
            case when curr.SELECTAUTH is null and prev.SELECTAUTH is not null then 'DEL'
                 when prev.SELECTAUTH is null and curr.SELECTAUTH is not null then 'NEW'
                 when curr.INSERTAUTH is null and prev.INSERTAUTH is not null then 'DEL'
                 when prev.INSERTAUTH is null and curr.INSERTAUTH is not null then 'NEW'
                 when curr.UPDATEAUTH is null and prev.UPDATEAUTH is not null then 'DEL'
                 when prev.UPDATEAUTH is null and curr.UPDATEAUTH is not null then 'NEW'
                 when curr.DELETEAUTH is null and prev.DELETEAUTH is not null then 'DEL'
                 when prev.DELETEAUTH is null and curr.DELETEAUTH is not null then 'NEW'
            else 'SAME' end sign_compare
        FROM curr_global curr
        FULL OUTER JOIN prev_global prev 
            ON ISNULL(prev.USERNAME,'')=ISNULL(curr.USERNAME,'') 
            	AND ISNULL(prev.ROLENAME,'')=ISNULL(curr.ROLENAME,'') 
            	AND ISNULL(prev.SCHEMANAME,'')=ISNULL(curr.SCHEMANAME,'') 
            	AND ISNULL(prev.TABLE_TYPE,'')=ISNULL(curr.TABLE_TYPE,'') 
            	AND ISNULL(prev.OBJECTNAME,'')=ISNULL(curr.OBJECTNAME,'')
            	AND ISNULL(prev.COLUMNNAME,'')=ISNULL(curr.COLUMNNAME,'')
            	AND ISNULL(prev.USERTYPE,'')=ISNULL(curr.USERTYPE,'') 
            	and ISNULL(prev.ACCESSTYPE,'')=ISNULL(curr.ACCESSTYPE,'') 
            	AND ISNULL(curr.SELECTAUTH,'')=ISNULL(prev.SELECTAUTH,'') 
            	AND ISNULL(curr.INSERTAUTH,'')=ISNULL(prev.INSERTAUTH,'') 
            	AND ISNULL(curr.UPDATEAUTH,'')=ISNULL(prev.UPDATEAUTH,'') 
            	AND ISNULL(curr.DELETEAUTH,'')=ISNULL(prev.DELETEAUTH,'') 
            	--and ISNULL(prev.PRIVILAGENAME,'')=ISNULL(curr.PRIVILAGENAME,'')
        WHERE curr.SELECTAUTH is not null 
        	AND curr.INSERTAUTH is not null
        	AND curr.UPDATEAUTH is not null
        	AND curr.DELETEAUTH is not null--without DELETED permission
        AND (ISNULL(P_WHITELIST,0)=0
                OR (not exists (select 1 from AUTH_DB2_LUW_REPORT.VW_DB2_LUW_ADMINS where USERID = ISNULL(curr.USERNAME, prev.USERNAME) ))
            )
        ORDER BY sign_compare, --strFullInstanceName, 
        username, rolename, table_type, AccessType, schemaname, Objectname, ColumnName;

  OPEN cur;

END @



