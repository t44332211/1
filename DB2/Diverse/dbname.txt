--instaance name
SELECT DISTINCT dbas.INSTANCE_CMDB_NAME
FROM  AUTH_REPORT.VW_REPORT_DB2_LUW_DATABASE dbas




--dbname
SELECT DISTINCT RPAD(dbas.DB_NAME,35), dbas.DB_CMDB_NAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DATABASE dbas
WHERE ( 1 = 1 or
		dbas.DBA_1=(select session_user from sysibm.sysdummy1) or
		dbas.DBA_2=(select session_user from sysibm.sysdummy1) or
		dbas.DBA_3=(select session_user from sysibm.sysdummy1) or
		dbas.DATA_ENABLER_1=(select session_user from sysibm.sysdummy1) or
		dbas.DATA_ENABLER_2=(select session_user from sysibm.sysdummy1) or
		dbas.DATA_ENABLER_3=(select session_user from sysibm.sysdummy1) or
		dbas.DATA_OWNER=(select session_user from sysibm.sysdummy1) or
		dbas.DATA_STEWARD_1=(select session_user from sysibm.sysdummy1) or
		dbas.DATA_STEWARD_2=(select session_user from sysibm.sysdummy1) or
		dbas.DATA_STEWARD_3=(select session_user from sysibm.sysdummy1) 
)
and trim(dbas.INSTANCE_CMDB_NAME)= trim('DBHADRWA auf HADRDWATSA2'); --  p_servername


--snapshot
SELECT RPAD(VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS'),35)
FROM AUTH_REPORT.VW_REPORT_DB2_luw_snapshots sp 
WHERE trim(sp.DB_CMDB_NAME) = trim('DWATSA2 in DBHADRWA auf HADRDWATSA2')
GROUP BY VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS');


--letzte certifizierung
SELECT RPAD(VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS'),35)
FROM AUTH_REPORT.VW_REPORT_DB2_luw_snapshots sp 
WHERE trim(sp.DB_CMDB_NAME) = trim('DWATSA2 in DBHADRWA auf HADRDWATSA2')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') < TRIM('30.07.2025 04:06:51')
GROUP BY VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') 
ORDER BY 1 DESC;


--unpivot for db_permission
SELECT GRANTEE, 
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 	   
	   'BINDADD' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim('DINDWHM in DBDWHMIN auf SDB00060')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM('15.07.2025 04:00:24')
     AND  sp.BINDADDAUTH != 'N'
UNION ALL
SELECT GRANTEE, 
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'CONNECT' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim('DINDWHM in DBDWHMIN auf SDB00060')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM('15.07.2025 04:00:24')
     AND  sp.CONNECTAUTH != 'N'
UNION ALL
SELECT GRANTEE, 
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
		'CREATETAB' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim('DINDWHM in DBDWHMIN auf SDB00060')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM('15.07.2025 04:00:24')
     AND  sp.CREATETABAUTH != 'N'
 UNION ALL
SELECT GRANTEE, 
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
		'DBADM' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim('DINDWHM in DBDWHMIN auf SDB00060')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM('15.07.2025 04:00:24')
     AND  sp.DBADMAUTH != 'N'
UNION ALL
SELECT GRANTEE, 
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'EXTERNALROUTINE' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim('DINDWHM in DBDWHMIN auf SDB00060')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM('15.07.2025 04:00:24')
     AND  sp.EXTERNALROUTINEAUTH != 'N'
UNION ALL
SELECT GRANTEE, 
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'IMPLSCHEMA' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim('DINDWHM in DBDWHMIN auf SDB00060')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM('15.07.2025 04:00:24')
     AND  sp.IMPLSCHEMAAUTH != 'N'
UNION ALL
SELECT GRANTEE, 
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'LOAD' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim('DINDWHM in DBDWHMIN auf SDB00060')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM('15.07.2025 04:00:24')
     AND  sp.LOADAUTH != 'N'
UNION ALL
SELECT GRANTEE, 
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'NOFENCE' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim('DINDWHM in DBDWHMIN auf SDB00060')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM('15.07.2025 04:00:24')
     AND  sp.NOFENCEAUTH != 'N'
UNION ALL
SELECT GRANTEE, 
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'QUIESCECONNECT' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim('DINDWHM in DBDWHMIN auf SDB00060')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM('15.07.2025 04:00:24')
     AND  sp.QUIESCECONNECTAUTH != 'N'
UNION ALL
SELECT GRANTEE, 
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'LIBRARYADM' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim('DINDWHM in DBDWHMIN auf SDB00060')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM('15.07.2025 04:00:24')
     AND  sp.LIBRARYADMAUTH != 'N'
UNION ALL
SELECT GRANTEE, 
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'SECURITYADM' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim('DINDWHM in DBDWHMIN auf SDB00060')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM('15.07.2025 04:00:24')
     AND  sp.SECURITYADMAUTH != 'N'
UNION ALL
SELECT GRANTEE, 
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'SQLADM' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim('DINDWHM in DBDWHMIN auf SDB00060')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM('15.07.2025 04:00:24')
     AND  sp.SQLADMAUTH != 'N'
UNION ALL
SELECT GRANTEE, 
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'WLMADM' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim('DINDWHM in DBDWHMIN auf SDB00060')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM('15.07.2025 04:00:24')
     AND  sp.WLMADMAUTH != 'N'
UNION ALL
SELECT GRANTEE, 
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'EXPLAIN' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim('DINDWHM in DBDWHMIN auf SDB00060')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM('15.07.2025 04:00:24')
     AND  sp.EXPLAINAUTH != 'N'
UNION ALL
SELECT GRANTEE, 
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'DATAACCESS' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim('DINDWHM in DBDWHMIN auf SDB00060')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM('15.07.2025 04:00:24')
     AND  sp.DATAACCESSAUTH != 'N'
UNION ALL
SELECT GRANTEE, 
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'ACCESSCTRL' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim('DINDWHM in DBDWHMIN auf SDB00060')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM('15.07.2025 04:00:24')
     AND  sp.ACCESSCTRLAUTH != 'N'
UNION ALL
SELECT GRANTEE, 
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	'CREATESECURE' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim('DINDWHM in DBDWHMIN auf SDB00060')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM('15.07.2025 04:00:24')
     AND  sp.CREATESECUREAUTH != 'N'
;


--unpivot for db_permission
SELECT GRANTEE, 
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'CONTROL' PRIVILAGENAME, 'TABLE' TABLE_TYPE, sp.TABSCHEMA SCHEMANAME, sp.TABNAME OBJECTNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim('DINDWHM in DBDWHMIN auf SDB00060')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM('15.07.2025 04:00:24')
     AND sp.CONTROLAUTH != 'N'
UNION ALL
SELECT GRANTEE, 
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'ALTER' PRIVILAGENAME, 'TABLE' TABLE_TYPE, sp.TABSCHEMA SCHEMANAME, sp.TABNAME OBJECTNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim('DINDWHM in DBDWHMIN auf SDB00060')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM('15.07.2025 04:00:24')
     AND sp.ALTERAUTH != 'N'   
UNION ALL
SELECT GRANTEE, 
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'DELETE' PRIVILAGENAME, 'TABLE' TABLE_TYPE, sp.TABSCHEMA SCHEMANAME, sp.TABNAME OBJECTNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim('DINDWHM in DBDWHMIN auf SDB00060')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM('15.07.2025 04:00:24')
     AND sp.DELETEAUTH != 'N'  
UNION ALL
SELECT GRANTEE, 
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'INDEX' PRIVILAGENAME, 'TABLE' TABLE_TYPE, sp.TABSCHEMA SCHEMANAME, sp.TABNAME OBJECTNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim('DINDWHM in DBDWHMIN auf SDB00060')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM('15.07.2025 04:00:24')
     AND sp.INDEXAUTH != 'N'  
UNION ALL
SELECT GRANTEE, 
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'INSERT' PRIVILAGENAME, 'TABLE' TABLE_TYPE, sp.TABSCHEMA SCHEMANAME, sp.TABNAME OBJECTNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim('DINDWHM in DBDWHMIN auf SDB00060')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM('15.07.2025 04:00:24')
     AND sp.INSERTAUTH != 'N'  
UNION ALL
SELECT GRANTEE, 
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'REF' PRIVILAGENAME, 'TABLE' TABLE_TYPE, sp.TABSCHEMA SCHEMANAME, sp.TABNAME OBJECTNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim('DINDWHM in DBDWHMIN auf SDB00060')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM('15.07.2025 04:00:24')
     AND sp.REFAUTH != 'N'  
UNION ALL
SELECT GRANTEE, 
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'SELECT' PRIVILAGENAME, 'TABLE' TABLE_TYPE, sp.TABSCHEMA SCHEMANAME, sp.TABNAME OBJECTNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim('DINDWHM in DBDWHMIN auf SDB00060')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM('15.07.2025 04:00:24')
     AND sp.SELECTAUTH != 'N'  
UNION ALL
SELECT GRANTEE, 
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'UPDATE' PRIVILAGENAME, 'TABLE' TABLE_TYPE, sp.TABSCHEMA SCHEMANAME, sp.TABNAME OBJECTNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim('DINDWHM in DBDWHMIN auf SDB00060')
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM('15.07.2025 04:00:24')
     AND sp.UPDATEAUTH != 'N'; 


select * FROM AUTH_REPORT.VW_REPORT_DB2_LUW_PRIVILEGES;  --to do 3
select * FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLES;
select * FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLEAUTH;
select * FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH where SUBSTRING(GRANTEE,1,1) != 'R'; -- database permission
select * FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH where SUBSTRING(GRANTEE,1,1) != 'R'; --todo 1
select * FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH --todo 2


----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



CREATE OR REPLACE PROCEDURE AUTH_DB2_LUW_REPORT.USP_PERSONROLELIST_PARA ( )
  SPECIFIC USP_PERSONROLELIST_PARA
  DYNAMIC RESULT SETS 1
  LANGUAGE SQL
  NOT DETERMINISTIC
  EXTERNAL ACTION
  MODIFIES SQL DATA
  CALLED ON NULL INPUT
  INHERIT SPECIAL REGISTERS
  OLD SAVEPOINT LEVEL
BEGIN 
  -- Required: procedure body with statements.  Each statement must be terminated with a semicolon.
  -- e.g. DECLARE cursor1 CURSOR WITH RETURN FOR SELECT PROCSCHEMA, PROCNAME FROM SYSCAT.PROCEDURES; 
  DECLARE cur CURSOR WITH RETURN FOR
		select RPAD('DataEnabler',35) 	PersonRole from sysibm.sysdummy1   
		union all
        select RPAD('DataOwner',35) 	PersonRole from sysibm.sysdummy1   
        union all
        select RPAD('DataSteward',35) 	PersonRole from sysibm.sysdummy1;
        
    OPEN cur;
  -- Optional: exception expressions
  -- EXCEPTION 
  -- WHEN { exception-condition } THEN { statement; } ... { statement; } 
  -- ... 
  -- WHEN { exception-condition } THEN { statement; } ... { statement; } 
END



CREATE OR REPLACE PROCEDURE AUTH_DB2_LUW_REPORT.USP_SERVERLIST_PARA ( )
  SPECIFIC USP_SERVERLIST_PARA
  DYNAMIC RESULT SETS 1
  LANGUAGE SQL
  NOT DETERMINISTIC
  EXTERNAL ACTION
  MODIFIES SQL DATA
  CALLED ON NULL INPUT
  INHERIT SPECIAL REGISTERS
  OLD SAVEPOINT LEVEL
BEGIN 
 	DECLARE cur CURSOR WITH RETURN FOR
 		SELECT DISTINCT dbas.INSTANCE_CMDB_NAME
		FROM  AUTH_DB2_LUW_REPORT.VW_REPORT_DB2_LUW_DATABASE dbas;
		
	OPEN cur;		
                                    
               
                                                                         
         
                                                                         
END


CREATE OR REPLACE PROCEDURE AUTH_DB2_LUW_REPORT.USP_DATABASELIST_PARA ( IN P_SERVERNAME VARCHAR(80) )
  SPECIFIC USP_DATABASELIST_PARA
  DYNAMIC RESULT SETS 1
  LANGUAGE SQL
  NOT DETERMINISTIC
  EXTERNAL ACTION
  MODIFIES SQL DATA
  CALLED ON NULL INPUT
  INHERIT SPECIAL REGISTERS
  OLD SAVEPOINT LEVEL
BEGIN 
  DECLARE cur CURSOR WITH RETURN FOR
 	SELECT DISTINCT RPAD(dbas.DB_NAME,35) DB_NAME, dbas.DB_CMDB_NAME
	FROM AUTH_DB2_LUW_REPORT.VW_REPORT_DB2_LUW_DATABASE dbas
	WHERE ( 1 = (select 1 from AUTH_DB2_LUW_REPORT.VW_DB2_LUW_ADMINS WHERE USERID=(select session_user from sysibm.sysdummy1)) or
		dbas.DBA_1=(select session_user from sysibm.sysdummy1) or
		dbas.DBA_2=(select session_user from sysibm.sysdummy1) or
		dbas.DBA_3=(select session_user from sysibm.sysdummy1) or
		dbas.DATA_ENABLER_1=(select session_user from sysibm.sysdummy1) or
		dbas.DATA_ENABLER_2=(select session_user from sysibm.sysdummy1) or
		dbas.DATA_ENABLER_3=(select session_user from sysibm.sysdummy1) or
		dbas.DATA_OWNER=(select session_user from sysibm.sysdummy1) or
		dbas.DATA_STEWARD_1=(select session_user from sysibm.sysdummy1) or
		dbas.DATA_STEWARD_2=(select session_user from sysibm.sysdummy1) or
		dbas.DATA_STEWARD_3=(select session_user from sysibm.sysdummy1) 
	)
	AND trim(dbas.INSTANCE_CMDB_NAME)= trim(P_SERVERNAME);
		
	OPEN cur;		
  -- Optional: exception expressions
  -- EXCEPTION 
  -- WHEN { exception-condition } THEN { statement; } ... { statement; } 
  -- ... 
  -- WHEN { exception-condition } THEN { statement; } ... { statement; } 
END




CREATE OR REPLACE PROCEDURE AUTH_DB2_LUW_REPORT.USP_SNAPSHOTLIST_PARA ( IN P_DB_CMDB_NAME VARCHAR(100) )
  SPECIFIC USP_SNAPSHOTLIST_PARA
  DYNAMIC RESULT SETS 1
  LANGUAGE SQL
  NOT DETERMINISTIC
  EXTERNAL ACTION
  MODIFIES SQL DATA
  CALLED ON NULL INPUT
  INHERIT SPECIAL REGISTERS
  OLD SAVEPOINT LEVEL
BEGIN 
  DECLARE cur CURSOR WITH RETURN FOR
 	SELECT RPAD(VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS'),35) dtTimestamp
	FROM AUTH_DB2_LUW_REPORT.VW_REPORT_DB2_luw_snapshots sp 
	WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
	GROUP BY VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS');
		
	OPEN cur;
  -- Optional: exception expressions
  -- EXCEPTION 
  -- WHEN { exception-condition } THEN { statement; } ... { statement; } 
  -- ... 
  -- WHEN { exception-condition } THEN { statement; } ... { statement; } 
END





CREATE OR REPLACE PROCEDURE AUTH_DB2_LUW_REPORT.USP_LATECERTLIST_PARA (
    IN P_DB_CMDB_NAME	VARCHAR(100),
    IN P_TIMESTAMP	VARCHAR(40) )
  SPECIFIC USP_LATECERTLIST_PARA
  DYNAMIC RESULT SETS 1
  LANGUAGE SQL
  NOT DETERMINISTIC
  EXTERNAL ACTION
  MODIFIES SQL DATA
  CALLED ON NULL INPUT
  INHERIT SPECIAL REGISTERS
  OLD SAVEPOINT LEVEL
BEGIN 
  	DECLARE cur CURSOR WITH RETURN FOR 
  	SELECT RPAD(VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS'),35) LateCert
	FROM AUTH_DB2_LUW_REPORT.VW_REPORT_DB2_luw_snapshots sp 
	WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
		AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') < TRIM(P_TIMESTAMP)
	GROUP BY VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') 
	UNION ALL
	SELECT NULL LateCert FROM sysibm.sysdummy1
	ORDER BY 1 DESC;

  OPEN cur;
  -- Optional: exception expressions
  -- EXCEPTION 
  -- WHEN { exception-condition } THEN { statement; } ... { statement; } 
  -- ... 
  -- WHEN { exception-condition } THEN { statement; } ... { statement; } 
END






--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
CREATE PROCEDURE "AUTH_DB2_LUW_REPORT"."USP_GLOBALPERM_DATA" (
  -- Optional: input and output parameters
  IN P_DB_CMDB_NAME VARCHAR(100),
  IN P_TIMESTAMP    VARCHAR(40),
  IN P_PREVTIMESTAMP VARCHAR(40),
  IN P_PERSONROLE VARCHAR(40)
  --   { parameter-name } [IN | OUT | IN OUT] { data-type } 
) 
DYNAMIC RESULT SETS 1 
LANGUAGE SQL 
SPECIFIC USP_GLOBALPERM_DATA
BEGIN 
	DECLARE cur CURSOR WITH RETURN FOR 
	WITH curr_global AS (
  
	SELECT rol.GRANTEE USERNAME, 
		CASE rol.GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
		 				    WHEN 'U' THEN 'DATABASE_USER'
		ELSE NULL END USERTYPE, 
		rol.ROLENAME,
		'GRANT' ACCESSTYPE,
		dbperm.PRIVILAGENAME,
		dbperm.TABLE_TYPE,
		dbperm.SCHEMANAME,
		dbperm.OBJECTNAME,
		dbperm.COLUMNNAME
 	FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLEAUTH rol
  	INNER JOIN (SELECT 	sp.DB_CMDB_NAME, 
						sp.GRANTEE, 
						sp.SNAP_TS,
						CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
												WHEN 'U' THEN 'DATABASE_USER'
						ELSE NULL END USERTYPE,
						'CONNECT' PRIVILAGENAME, 
						'DATABASE' TABLE_TYPE, 
						'*' SCHEMANAME, 
						'*' OBJECTNAME, 
						'*' COLUMNNAME 
				FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
				WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
					AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
					AND  sp.CONNECTAUTH != 'N' ) dbperm  
   		ON trim(rol.DB_CMDB_NAME) = trim(dbperm.DB_CMDB_NAME)
   			AND rol.SNAP_TS = dbperm.SNAP_TS
   			AND (rol.GRANTEE = dbperm.GRANTEE OR rol.ROLENAME  = dbperm.GRANTEE)
	WHERE trim(rol.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
    	AND VARCHAR_FORMAT(rol.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP) 
	UNION ALL
	SELECT 	sp.GRANTEE USERNAME, 
			CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
									WHEN 'U' THEN 'DATABASE_USER'
			ELSE NULL END USERTYPE,
			sp.ROLENAME,
			'GRANT' ACCESSTYPE,
			'CONNECT' PRIVILAGENAME, 
			'DATABASE' TABLE_TYPE, 
			'*' SCHEMANAME, 
			'*' OBJECTNAME, 
			'*' COLUMNNAME
	FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLEAUTH sp
	WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
		AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
		AND sp.ROLENAME LIKE '%CONNECT%'
	),
	prev_global AS (
  
	SELECT rol.GRANTEE USERNAME, 
		CASE rol.GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
		 				    WHEN 'U' THEN 'DATABASE_USER'
		ELSE NULL END USERTYPE, 
		rol.ROLENAME,
		'GRANT' ACCESSTYPE,
		dbperm.PRIVILAGENAME,
		dbperm.TABLE_TYPE,
		dbperm.SCHEMANAME,
		dbperm.OBJECTNAME,
		dbperm.COLUMNNAME
 	FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLEAUTH rol
  	INNER JOIN (SELECT 	sp.DB_CMDB_NAME, 
						sp.GRANTEE, 
						sp.SNAP_TS,
						CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
												WHEN 'U' THEN 'DATABASE_USER'
						ELSE NULL END USERTYPE,
						'CONNECT' PRIVILAGENAME, 
						'DATABASE' TABLE_TYPE, 
						'*' SCHEMANAME, 
						'*' OBJECTNAME, 
						'*' COLUMNNAME 
				FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
				WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
					AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
					AND  sp.CONNECTAUTH != 'N' ) dbperm  
   		ON trim(rol.DB_CMDB_NAME) = trim(dbperm.DB_CMDB_NAME)
   			AND rol.SNAP_TS = dbperm.SNAP_TS
   			AND (rol.GRANTEE = dbperm.GRANTEE OR rol.ROLENAME  = dbperm.GRANTEE)
	WHERE trim(rol.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
    	AND VARCHAR_FORMAT(rol.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP) 
	UNION ALL
	SELECT 	sp.GRANTEE USERNAME, 
			CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
									WHEN 'U' THEN 'DATABASE_USER'
			ELSE NULL END USERTYPE,
			sp.ROLENAME,
			'GRANT' ACCESSTYPE,
			'CONNECT' PRIVILAGENAME, 
			'DATABASE' TABLE_TYPE, 
			'*' SCHEMANAME, 
			'*' OBJECTNAME, 
			'*' COLUMNNAME
	FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLEAUTH sp
	WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
		AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
		AND sp.ROLENAME LIKE '%CONNECT%'
	)
	
	SELECT DISTINCT 
            'Global permission' Global, 
            ISNULL(curr.USERNAME, prev.USERNAME)			            	as username, 
            ISNULL(curr.ROLENAME, prev.ROLENAME)							as rolename,
            ISNULL(curr.SCHEMANAME, prev.SCHEMANAME)						as schemaname,
            ISNULL(curr.TABLE_TYPE, prev.TABLE_TYPE)				    	as table_type,		
            case ISNULL(curr.USERTYPE, prev.USERTYPE)	when 'U' then 'DATABASE_USER'
                                                    	when 'R' then 'DATABASE_ROLE'
            else ISNULL(curr.USERTYPE, prev.USERTYPE) end              	as usertype,
            ISNULL(curr.ACCESSTYPE, prev.ACCESSTYPE)						as AccessType,
            ISNULL(curr.PRIVILAGENAME, prev.PRIVILAGENAME)		    		as Privilege,
            ISNULL(curr.OBJECTNAME, prev.OBJECTNAME)				    	as Objectname,
            ISNULL(curr.COLUMNNAME, prev.COLUMNNAME)						as ColumnName,
            case when curr.PRIVILAGENAME is null and prev.PRIVILAGENAME is not null then 'DEL'
                 when prev.PRIVILAGENAME is null and curr.PRIVILAGENAME is not null then 'NEW'
            else 'SAME' end sign_compare
        FROM curr_global curr
        FULL OUTER JOIN prev_global prev 
            ON ISNULL(prev.USERNAME,'')=ISNULL(curr.USERNAME,'') 
            	AND ISNULL(prev.ROLENAME,'')=ISNULL(curr.ROLENAME,'') 
            	AND ISNULL(prev.SCHEMANAME,'')=ISNULL(curr.SCHEMANAME,'') 
            	AND ISNULL(prev.TABLE_TYPE,'')=ISNULL(curr.TABLE_TYPE,'') 
            	AND ISNULL(prev.OBJECTNAME,'')=ISNULL(curr.OBJECTNAME,'')
            	AND ISNULL(prev.COLUMNNAME,'')=ISNULL(curr.COLUMNNAME,'')
            	AND ISNULL(prev.USERTYPE,'')=ISNULL(curr.USERTYPE,'') 
            	and ISNULL(prev.ACCESSTYPE,'')=ISNULL(curr.ACCESSTYPE,'') 
            	and ISNULL(prev.PRIVILAGENAME,'')=ISNULL(curr.PRIVILAGENAME,'')
        WHERE curr.PRIVILAGENAME is not null --without DELETED permission
        ORDER BY sign_compare, --strFullInstanceName, 
        username, rolename, table_type, AccessType, Privilege, schemaname, Objectname, ColumnName;

  OPEN cur;
  -- Optional: exception expressions
  -- EXCEPTION 
  -- WHEN { exception-condition } THEN { statement; } ... { statement; } 
  -- ... 
  -- WHEN { exception-condition } THEN { statement; } ... { statement; } 
END @

--
-- Optional: grant the procedure privilege
--
-- GRANT EXECUTE ON PROCEDURE { procedure-name }
--   TO { [ USER | GROUP | ROLE ] { grantee-name } } | PUBLIC @


------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
CREATE PROCEDURE "AUTH_DB2_LUW_REPORT"."USP_OBJECTPERM_DATA" (
  -- Optional: input and output parameters
  IN P_DB_CMDB_NAME VARCHAR(100),
  IN P_TIMESTAMP    VARCHAR(40),
  in P_PREVTIMESTAMP VARCHAR(40),
  IN P_PERSONROLE VARCHAR(40)
  --   { parameter-name } [IN | OUT | IN OUT] { data-type } 
) 
DYNAMIC RESULT SETS 1 
LANGUAGE SQL 
SPECIFIC USP_OBJECTPERM_DATA
BEGIN 
	DECLARE cur CURSOR WITH RETURN FOR 
	WITH curr_global as (
	WITH dbperm_ as (
--unpivot for db_permission 
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 	   
	   'BINDADD' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.BINDADDAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
		'CREATETAB' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.CREATETABAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
		'DBADM' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.DBADMAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'EXTERNALROUTINE' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.EXTERNALROUTINEAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'IMPLSCHEMA' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.IMPLSCHEMAAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'LOAD' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.LOADAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'NOFENCE' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.NOFENCEAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'QUIESCECONNECT' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.QUIESCECONNECTAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'LIBRARYADM' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.LIBRARYADMAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'SECURITYADM' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.SECURITYADMAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'SQLADM' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.SQLADMAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'WLMADM' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.WLMADMAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'EXPLAIN' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.EXPLAINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'DATAACCESS' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.DATAACCESSAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'ACCESSCTRL' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.ACCESSCTRLAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	'CREATESECURE' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.CREATESECUREAUTH != 'N'
)
, tabperm_ as (
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS, 
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'CONTROL' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.CONTROLAUTH != 'N'
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS, 
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'ALTER' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.ALTERAUTH != 'N'   
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS, 
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'DELETE' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.DELETEAUTH != 'N'  
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS, 
	   CASE sp.GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'INDEX' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp

WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.INDEXAUTH != 'N'  
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS,  
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'INSERT' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.INSERTAUTH != 'N'  
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS,  
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'REF' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.REFAUTH != 'N'  
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS, 
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'SELECT' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.SELECTAUTH != 'N'  
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS,  
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'UPDATE' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.UPDATEAUTH != 'N'
),
schperm_ as (
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'ALTERIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.ALTERINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'CREATEIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.CREATEINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'DROPIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.DROPINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'SELECTIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.SELECTINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'INSERTIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.INSERTINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE,  sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'UPDATEIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.UPDATEINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'DELETEIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.DELETEINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE,  sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'EXECUTEIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.EXECUTEINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'SCHEMAADM' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.SCHEMAADMAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'ACCESSCTRL' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.ACCESSCTRLAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'DATAACCESS' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.DATAACCESSAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'LOAD' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.LOADAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'SCHEMARCAC' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.SCHEMARCACAUTH != 'N'
),
colperm_ as (
SELECT sp. DB_CMDB_NAME, sp.GRANTEE, sp.TIMESTAMP SNAP_TS,
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'SELECT' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   sp.COLNAME COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_COLAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.TIMESTAMP,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
)
 SELECT rol.GRANTEE USERNAME, 
		CASE rol.GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
		 				    WHEN 'U' THEN 'DATABASE_USER'
		ELSE NULL END USERTYPE, 
		rol.ROLENAME,
		'GRANT' ACCESSTYPE,
		dbperm.PRIVILAGENAME,
		dbperm.TABLE_TYPE,
		dbperm.SCHEMANAME,
		dbperm.OBJECTNAME,
		dbperm.COLUMNNAME
 FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLEAUTH rol
  INNER JOIN dbperm_ dbperm  
   ON trim(rol.DB_CMDB_NAME) = trim(dbperm.DB_CMDB_NAME)
   		AND rol.SNAP_TS = dbperm.SNAP_TS
   		AND (rol.GRANTEE = dbperm.GRANTEE OR rol.ROLENAME  = dbperm.GRANTEE)
 WHERE trim(rol.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
    AND VARCHAR_FORMAT(rol.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)  
    AND TRIM(P_PERSONROLE) != 'DataSteward'
 UNION ALL
 SELECT rol.GRANTEE USERNAME, 
	   CASE rol.GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   rol.ROLENAME,
	   'GRANT' ACCESSTYPE,
	   tabperm.PRIVILAGENAME,
	   tabperm.TABLE_TYPE,
	   tabperm.SCHEMANAME,
	   tabperm.OBJECTNAME,
	   tabperm.COLUMNNAME
 FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLEAUTH rol
 INNER JOIN tabperm_ tabperm 
   ON trim(rol.DB_CMDB_NAME) = trim(tabperm.DB_CMDB_NAME)
   		AND rol.SNAP_TS = tabperm.SNAP_TS
   		AND (rol.GRANTEE = tabperm.GRANTEE OR rol.ROLENAME  = tabperm.GRANTEE)
 WHERE trim(rol.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
    AND VARCHAR_FORMAT(rol.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)  
    AND TRIM(P_PERSONROLE) != 'DataSteward'
 UNION ALL
  SELECT rol.GRANTEE USERNAME, 
	   CASE rol.GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   rol.ROLENAME,
	   'GRANT' ACCESSTYPE,
	   schperm.PRIVILAGENAME,
	   schperm.TABLE_TYPE,
	   schperm.SCHEMANAME,
	   schperm.OBJECTNAME,
	   schperm.COLUMNNAME
 FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLEAUTH rol
 INNER JOIN schperm_ schperm
   ON trim(rol.DB_CMDB_NAME) = trim(schperm.DB_CMDB_NAME)
   		AND rol.SNAP_TS = schperm.SNAP_TS
   		AND (rol.GRANTEE = schperm.GRANTEE OR rol.ROLENAME  = schperm.GRANTEE)
 WHERE trim(rol.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
    AND VARCHAR_FORMAT(rol.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP) 
    AND TRIM(P_PERSONROLE) != 'DataSteward'
UNION ALL
SELECT rol.GRANTEE USERNAME, 
	   CASE rol.GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   rol.ROLENAME,
	   'GRANT' ACCESSTYPE,
	   colperm.PRIVILAGENAME,
	   colperm.TABLE_TYPE,
	   colperm.SCHEMANAME,
	   colperm.OBJECTNAME,
	   ISNULL(colperm.COLUMNNAME,'*') COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLEAUTH rol
INNER JOIN colperm_ colperm
	ON trim(rol.DB_CMDB_NAME) = trim(colperm.DB_CMDB_NAME)
   		AND rol.SNAP_TS = colperm.SNAP_TS
   		AND (rol.GRANTEE = colperm.GRANTEE OR rol.ROLENAME  = colperm.GRANTEE)
WHERE trim(rol.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
    AND VARCHAR_FORMAT(rol.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
    AND TRIM(P_PERSONROLE) != 'DataSteward'
    ),
    
    
    
    prev_global as (
    
    
    
    WITH dbperm as (
--unpivot for db_permission 
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 	   
	   'BINDADD' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.BINDADDAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'CONNECT' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.CONNECTAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
		'CREATETAB' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.CREATETABAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
		'DBADM' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.DBADMAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'EXTERNALROUTINE' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.EXTERNALROUTINEAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'IMPLSCHEMA' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.IMPLSCHEMAAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'LOAD' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.LOADAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'NOFENCE' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.NOFENCEAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'QUIESCECONNECT' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.QUIESCECONNECTAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'LIBRARYADM' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.LIBRARYADMAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'SECURITYADM' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.SECURITYADMAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'SQLADM' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.SQLADMAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'WLMADM' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.WLMADMAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'EXPLAIN' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.EXPLAINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'DATAACCESS' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.DATAACCESSAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'ACCESSCTRL' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.ACCESSCTRLAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	'CREATESECURE' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.CREATESECUREAUTH != 'N'
)
, tabperm as (
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS, 
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'CONTROL' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.CONTROLAUTH != 'N'
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS, 
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'ALTER' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.ALTERAUTH != 'N'   
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS, 
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'DELETE' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.DELETEAUTH != 'N'  
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS, 
	   CASE sp.GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'INDEX' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp

WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.INDEXAUTH != 'N'  
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS,  
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'INSERT' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.INSERTAUTH != 'N'  
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS,  
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'REF' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.REFAUTH != 'N'  
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS, 
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'SELECT' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.SELECTAUTH != 'N'  
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS,  
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'UPDATE' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.UPDATEAUTH != 'N'
),
schperm as (
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'ALTERIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.ALTERINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'CREATEIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.CREATEINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'DROPIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.DROPINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'SELECTIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.SELECTINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'INSERTIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.INSERTINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE,  sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'UPDATEIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.UPDATEINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'DELETEIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.DELETEINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE,  sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'EXECUTEIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.EXECUTEINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'SCHEMAADM' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.SCHEMAADMAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'ACCESSCTRL' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.ACCESSCTRLAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'DATAACCESS' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.DATAACCESSAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'LOAD' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.LOADAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'SCHEMARCAC' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.SCHEMARCACAUTH != 'N'
),
colperm as (
SELECT sp. DB_CMDB_NAME, sp.GRANTEE, sp.TIMESTAMP SNAP_TS,
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'SELECT' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   sp.COLNAME COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_COLAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.TIMESTAMP,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
)
 SELECT rol.GRANTEE USERNAME, 
		CASE rol.GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
		 				    WHEN 'U' THEN 'DATABASE_USER'
		ELSE NULL END USERTYPE, 
		rol.ROLENAME,
		'GRANT' ACCESSTYPE,
		dbperm.PRIVILAGENAME,
		dbperm.TABLE_TYPE,
		dbperm.SCHEMANAME,
		dbperm.OBJECTNAME,
		dbperm.COLUMNNAME
 FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLEAUTH rol
  INNER JOIN dbperm  
   ON trim(rol.DB_CMDB_NAME) = trim(dbperm.DB_CMDB_NAME)
   		AND rol.SNAP_TS = dbperm.SNAP_TS
   		AND (rol.GRANTEE = dbperm.GRANTEE OR rol.ROLENAME  = dbperm.GRANTEE)
 WHERE trim(rol.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
    AND VARCHAR_FORMAT(rol.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)  
    AND TRIM(P_PERSONROLE) != 'DataSteward'
 UNION ALL
 SELECT rol.GRANTEE USERNAME, 
	   CASE rol.GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   rol.ROLENAME,
	   'GRANT' ACCESSTYPE,
	   tabperm.PRIVILAGENAME,
	   tabperm.TABLE_TYPE,
	   tabperm.SCHEMANAME,
	   tabperm.OBJECTNAME,
	   tabperm.COLUMNNAME
 FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLEAUTH rol
 INNER JOIN tabperm  
   ON trim(rol.DB_CMDB_NAME) = trim(tabperm.DB_CMDB_NAME)
   		AND rol.SNAP_TS = tabperm.SNAP_TS
   		AND (rol.GRANTEE = tabperm.GRANTEE OR rol.ROLENAME  = tabperm.GRANTEE)
 WHERE trim(rol.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
    AND VARCHAR_FORMAT(rol.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)  
    AND TRIM(P_PERSONROLE) != 'DataSteward'
 UNION ALL
  SELECT rol.GRANTEE USERNAME, 
	   CASE rol.GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   rol.ROLENAME,
	   'GRANT' ACCESSTYPE,
	   schperm.PRIVILAGENAME,
	   schperm.TABLE_TYPE,
	   schperm.SCHEMANAME,
	   schperm.OBJECTNAME,
	   schperm.COLUMNNAME
 FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLEAUTH rol
 INNER JOIN schperm  
   ON trim(rol.DB_CMDB_NAME) = trim(schperm.DB_CMDB_NAME)
   		AND rol.SNAP_TS = schperm.SNAP_TS
   		AND (rol.GRANTEE = schperm.GRANTEE OR rol.ROLENAME  = schperm.GRANTEE)
 WHERE trim(rol.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
    AND VARCHAR_FORMAT(rol.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
    AND TRIM(P_PERSONROLE) != 'DataSteward'
UNION ALL
SELECT rol.GRANTEE USERNAME, 
	   CASE rol.GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   rol.ROLENAME,
	   'GRANT' ACCESSTYPE,
	   colperm.PRIVILAGENAME,
	   colperm.TABLE_TYPE,
	   colperm.SCHEMANAME,
	   colperm.OBJECTNAME,
	   ISNULL(colperm.COLUMNNAME,'*') COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLEAUTH rol
INNER JOIN colperm  
	ON trim(rol.DB_CMDB_NAME) = trim(colperm.DB_CMDB_NAME)
   		AND rol.SNAP_TS = colperm.SNAP_TS
   		AND (rol.GRANTEE = colperm.GRANTEE OR rol.ROLENAME  = colperm.GRANTEE)
WHERE trim(rol.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
    AND VARCHAR_FORMAT(rol.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
    AND TRIM(P_PERSONROLE) != 'DataSteward'
 ORDER BY COLUMNNAME DESC
    )
    SELECT DISTINCT 
            'Global permission' Global, 
            ISNULL(curr.USERNAME, prev.USERNAME)			            	as username, 
            ISNULL(curr.ROLENAME, prev.ROLENAME)							as rolename,
            ISNULL(curr.SCHEMANAME, prev.SCHEMANAME)						as schemaname,
            ISNULL(curr.TABLE_TYPE, prev.TABLE_TYPE)				    	as table_type,		
            case ISNULL(curr.USERTYPE, prev.USERTYPE)	when 'U' then 'DATABASE_USER'
                                                    	when 'R' then 'DATABASE_ROLE'
            else ISNULL(curr.USERTYPE, prev.USERTYPE) end              	as usertype,
            ISNULL(curr.ACCESSTYPE, prev.ACCESSTYPE)						as AccessType,
            ISNULL(curr.PRIVILAGENAME, prev.PRIVILAGENAME)		    		as Privilege,
            ISNULL(curr.OBJECTNAME, prev.OBJECTNAME)				    	as Objectname,
            ISNULL(curr.COLUMNNAME, prev.COLUMNNAME)						as ColumnName,
            case when curr.PRIVILAGENAME is null and prev.PRIVILAGENAME is not null then 'DEL'
                 when prev.PRIVILAGENAME is null and curr.PRIVILAGENAME is not null then 'NEW'
            else 'SAME' end sign_compare
        FROM curr_global curr
        FULL OUTER JOIN prev_global prev 
            ON ISNULL(prev.USERNAME,'')=ISNULL(curr.USERNAME,'') 
            	AND ISNULL(prev.ROLENAME,'')=ISNULL(curr.ROLENAME,'') 
            	AND ISNULL(prev.SCHEMANAME,'')=ISNULL(curr.SCHEMANAME,'') 
            	AND ISNULL(prev.TABLE_TYPE,'')=ISNULL(curr.TABLE_TYPE,'') 
            	AND ISNULL(prev.OBJECTNAME,'')=ISNULL(curr.OBJECTNAME,'')
            	AND ISNULL(prev.COLUMNNAME,'')=ISNULL(curr.COLUMNNAME,'')
            	AND ISNULL(prev.USERTYPE,'')=ISNULL(curr.USERTYPE,'') 
            	and ISNULL(prev.ACCESSTYPE,'')=ISNULL(curr.ACCESSTYPE,'') 
            	and ISNULL(prev.PRIVILAGENAME,'')=ISNULL(curr.PRIVILAGENAME,'')
        WHERE curr.PRIVILAGENAME is not null --without DELETED permission
        ORDER BY sign_compare, --strFullInstanceName, 
        username, rolename, table_type, AccessType, Privilege, schemaname, Objectname, ColumnName;
  OPEN cur;
  -- Optional: exception expressions
  -- EXCEPTION 
  -- WHEN { exception-condition } THEN { statement; } ... { statement; } 
  -- ... 
  -- WHEN { exception-condition } THEN { statement; } ... { statement; } 
END @

--
-- Optional: grant the procedure privilege
--
-- GRANT EXECUTE ON PROCEDURE { procedure-name }
--   TO { [ USER | GROUP | ROLE ] { grantee-name } } | PUBLIC @

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

CREATE PROCEDURE "AUTH_DB2_LUW_REPORT"."USP_DELPERM_DATA" (
  -- Optional: input and output parameters
  IN P_DB_CMDB_NAME VARCHAR(100),
  IN P_TIMESTAMP    VARCHAR(40),
  in P_PREVTIMESTAMP VARCHAR(40),
  IN P_PERSONROLE VARCHAR(40)
  --   { parameter-name } [IN | OUT | IN OUT] { data-type } 
) 
DYNAMIC RESULT SETS 1 
LANGUAGE SQL 
SPECIFIC USP_DELPERM_DATA
BEGIN 
	DECLARE cur CURSOR WITH RETURN FOR 
	WITH curr_global AS (
  
	SELECT rol.GRANTEE USERNAME, 
		CASE rol.GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
		 				    WHEN 'U' THEN 'DATABASE_USER'
		ELSE NULL END USERTYPE, 
		rol.ROLENAME,
		'GRANT' ACCESSTYPE,
		dbperm.PRIVILAGENAME,
		dbperm.TABLE_TYPE,
		dbperm.SCHEMANAME,
		dbperm.OBJECTNAME,
		dbperm.COLUMNNAME
 	FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLEAUTH rol
  	INNER JOIN (SELECT 	sp.DB_CMDB_NAME, 
						sp.GRANTEE, 
						sp.SNAP_TS,
						CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
												WHEN 'U' THEN 'DATABASE_USER'
						ELSE NULL END USERTYPE,
						'CONNECT' PRIVILAGENAME, 
						'DATABASE' TABLE_TYPE, 
						'*' SCHEMANAME, 
						'*' OBJECTNAME, 
						'*' COLUMNNAME 
				FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
				WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
					AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
					AND  sp.CONNECTAUTH != 'N' ) dbperm  
   		ON trim(rol.DB_CMDB_NAME) = trim(dbperm.DB_CMDB_NAME)
   			AND rol.SNAP_TS = dbperm.SNAP_TS
   			AND (rol.GRANTEE = dbperm.GRANTEE OR rol.ROLENAME  = dbperm.GRANTEE)
	WHERE trim(rol.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
    	AND VARCHAR_FORMAT(rol.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP) 
	UNION ALL
	SELECT 	sp.GRANTEE USERNAME, 
			CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
									WHEN 'U' THEN 'DATABASE_USER'
			ELSE NULL END USERTYPE,
			sp.ROLENAME,
			'GRANT' ACCESSTYPE,
			'CONNECT' PRIVILAGENAME, 
			'DATABASE' TABLE_TYPE, 
			'*' SCHEMANAME, 
			'*' OBJECTNAME, 
			'*' COLUMNNAME
	FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLEAUTH sp
	WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
		AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
		AND sp.ROLENAME LIKE '%CONNECT%'
	),
	prev_global AS (
  
	SELECT rol.GRANTEE USERNAME, 
		CASE rol.GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
		 				    WHEN 'U' THEN 'DATABASE_USER'
		ELSE NULL END USERTYPE, 
		rol.ROLENAME,
		'GRANT' ACCESSTYPE,
		dbperm.PRIVILAGENAME,
		dbperm.TABLE_TYPE,
		dbperm.SCHEMANAME,
		dbperm.OBJECTNAME,
		dbperm.COLUMNNAME
 	FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLEAUTH rol
  	INNER JOIN (SELECT 	sp.DB_CMDB_NAME, 
						sp.GRANTEE, 
						sp.SNAP_TS,
						CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
												WHEN 'U' THEN 'DATABASE_USER'
						ELSE NULL END USERTYPE,
						'CONNECT' PRIVILAGENAME, 
						'DATABASE' TABLE_TYPE, 
						'*' SCHEMANAME, 
						'*' OBJECTNAME, 
						'*' COLUMNNAME 
				FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
				WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
					AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
					AND  sp.CONNECTAUTH != 'N' ) dbperm  
   		ON trim(rol.DB_CMDB_NAME) = trim(dbperm.DB_CMDB_NAME)
   			AND rol.SNAP_TS = dbperm.SNAP_TS
   			AND (rol.GRANTEE = dbperm.GRANTEE OR rol.ROLENAME  = dbperm.GRANTEE)
	WHERE trim(rol.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
    	AND VARCHAR_FORMAT(rol.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP) 
	UNION ALL
	SELECT 	sp.GRANTEE USERNAME, 
			CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
									WHEN 'U' THEN 'DATABASE_USER'
			ELSE NULL END USERTYPE,
			sp.ROLENAME,
			'GRANT' ACCESSTYPE,
			'CONNECT' PRIVILAGENAME, 
			'DATABASE' TABLE_TYPE, 
			'*' SCHEMANAME, 
			'*' OBJECTNAME, 
			'*' COLUMNNAME
	FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLEAUTH sp
	WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
		AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
		AND sp.ROLENAME LIKE '%CONNECT%'
	), 
	
	
	curr_object as (
	WITH dbperm_ as (
--unpivot for db_permission 
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 	   
	   'BINDADD' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.BINDADDAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
		'CREATETAB' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.CREATETABAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
		'DBADM' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.DBADMAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'EXTERNALROUTINE' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.EXTERNALROUTINEAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'IMPLSCHEMA' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.IMPLSCHEMAAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'LOAD' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.LOADAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'NOFENCE' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.NOFENCEAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'QUIESCECONNECT' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.QUIESCECONNECTAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'LIBRARYADM' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.LIBRARYADMAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'SECURITYADM' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.SECURITYADMAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'SQLADM' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.SQLADMAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'WLMADM' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.WLMADMAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'EXPLAIN' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.EXPLAINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'DATAACCESS' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.DATAACCESSAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'ACCESSCTRL' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.ACCESSCTRLAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	'CREATESECURE' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND  sp.CREATESECUREAUTH != 'N'
)
, tabperm_ as (
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS, 
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'CONTROL' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.CONTROLAUTH != 'N'
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS, 
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'ALTER' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.ALTERAUTH != 'N'   
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS, 
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'DELETE' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.DELETEAUTH != 'N'  
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS, 
	   CASE sp.GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'INDEX' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp

WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.INDEXAUTH != 'N'  
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS,  
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'INSERT' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.INSERTAUTH != 'N'  
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS,  
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'REF' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.REFAUTH != 'N'  
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS, 
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'SELECT' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.SELECTAUTH != 'N'  
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS,  
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'UPDATE' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.UPDATEAUTH != 'N'
),
schperm_ as (
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'ALTERIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.ALTERINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'CREATEIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.CREATEINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'DROPIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.DROPINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'SELECTIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.SELECTINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'INSERTIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.INSERTINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE,  sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'UPDATEIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.UPDATEINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'DELETEIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.DELETEINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE,  sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'EXECUTEIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.EXECUTEINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'SCHEMAADM' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.SCHEMAADMAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'ACCESSCTRL' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.ACCESSCTRLAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'DATAACCESS' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.DATAACCESSAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'LOAD' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.LOADAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'SCHEMARCAC' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
     AND sp.SCHEMARCACAUTH != 'N'
),
colperm_ as (
SELECT sp. DB_CMDB_NAME, sp.GRANTEE, sp.TIMESTAMP SNAP_TS,
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'SELECT' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   sp.COLNAME COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_COLAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.TIMESTAMP,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
)
 SELECT rol.GRANTEE USERNAME, 
		CASE rol.GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
		 				    WHEN 'U' THEN 'DATABASE_USER'
		ELSE NULL END USERTYPE, 
		rol.ROLENAME,
		'GRANT' ACCESSTYPE,
		dbperm.PRIVILAGENAME,
		dbperm.TABLE_TYPE,
		dbperm.SCHEMANAME,
		dbperm.OBJECTNAME,
		dbperm.COLUMNNAME
 FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLEAUTH rol
  INNER JOIN dbperm_ dbperm  
   ON trim(rol.DB_CMDB_NAME) = trim(dbperm.DB_CMDB_NAME)
   		AND rol.SNAP_TS = dbperm.SNAP_TS
   		AND (rol.GRANTEE = dbperm.GRANTEE OR rol.ROLENAME  = dbperm.GRANTEE)
 WHERE trim(rol.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
    AND VARCHAR_FORMAT(rol.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)  
    AND TRIM(P_PERSONROLE) != 'DataSteward'
 UNION ALL
 SELECT rol.GRANTEE USERNAME, 
	   CASE rol.GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   rol.ROLENAME,
	   'GRANT' ACCESSTYPE,
	   tabperm.PRIVILAGENAME,
	   tabperm.TABLE_TYPE,
	   tabperm.SCHEMANAME,
	   tabperm.OBJECTNAME,
	   tabperm.COLUMNNAME
 FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLEAUTH rol
 INNER JOIN tabperm_ tabperm 
   ON trim(rol.DB_CMDB_NAME) = trim(tabperm.DB_CMDB_NAME)
   		AND rol.SNAP_TS = tabperm.SNAP_TS
   		AND (rol.GRANTEE = tabperm.GRANTEE OR rol.ROLENAME  = tabperm.GRANTEE)
 WHERE trim(rol.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
    AND VARCHAR_FORMAT(rol.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)  
    AND TRIM(P_PERSONROLE) != 'DataSteward'
 UNION ALL
  SELECT rol.GRANTEE USERNAME, 
	   CASE rol.GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   rol.ROLENAME,
	   'GRANT' ACCESSTYPE,
	   schperm.PRIVILAGENAME,
	   schperm.TABLE_TYPE,
	   schperm.SCHEMANAME,
	   schperm.OBJECTNAME,
	   schperm.COLUMNNAME
 FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLEAUTH rol
 INNER JOIN schperm_ schperm
   ON trim(rol.DB_CMDB_NAME) = trim(schperm.DB_CMDB_NAME)
   		AND rol.SNAP_TS = schperm.SNAP_TS
   		AND (rol.GRANTEE = schperm.GRANTEE OR rol.ROLENAME  = schperm.GRANTEE)
 WHERE trim(rol.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
    AND VARCHAR_FORMAT(rol.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP) 
    AND TRIM(P_PERSONROLE) != 'DataSteward'
UNION ALL
SELECT rol.GRANTEE USERNAME, 
	   CASE rol.GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   rol.ROLENAME,
	   'GRANT' ACCESSTYPE,
	   colperm.PRIVILAGENAME,
	   colperm.TABLE_TYPE,
	   colperm.SCHEMANAME,
	   colperm.OBJECTNAME,
	   ISNULL(colperm.COLUMNNAME,'*') COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLEAUTH rol
INNER JOIN colperm_ colperm
	ON trim(rol.DB_CMDB_NAME) = trim(colperm.DB_CMDB_NAME)
   		AND rol.SNAP_TS = colperm.SNAP_TS
   		AND (rol.GRANTEE = colperm.GRANTEE OR rol.ROLENAME  = colperm.GRANTEE)
WHERE trim(rol.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
    AND VARCHAR_FORMAT(rol.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_TIMESTAMP)
    AND TRIM(P_PERSONROLE) != 'DataSteward'
    ),
    
    
    
    prev_object as (
    
    
    
    WITH dbperm as (
--unpivot for db_permission 
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 	   
	   'BINDADD' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.BINDADDAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'CONNECT' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.CONNECTAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
		'CREATETAB' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.CREATETABAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
		'DBADM' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.DBADMAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'EXTERNALROUTINE' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.EXTERNALROUTINEAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'IMPLSCHEMA' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.IMPLSCHEMAAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'LOAD' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.LOADAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'NOFENCE' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.NOFENCEAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'QUIESCECONNECT' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.QUIESCECONNECTAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'LIBRARYADM' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.LIBRARYADMAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'SECURITYADM' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.SECURITYADMAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'SQLADM' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.SQLADMAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'WLMADM' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.WLMADMAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'EXPLAIN' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.EXPLAINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'DATAACCESS' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.DATAACCESSAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'ACCESSCTRL' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.ACCESSCTRLAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	'CREATESECURE' PRIVILAGENAME, 'DATABASE' TABLE_TYPE, '*' SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_DBAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND  sp.CREATESECUREAUTH != 'N'
)
, tabperm as (
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS, 
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'CONTROL' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.CONTROLAUTH != 'N'
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS, 
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'ALTER' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.ALTERAUTH != 'N'   
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS, 
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'DELETE' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.DELETEAUTH != 'N'  
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS, 
	   CASE sp.GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'INDEX' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp

WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.INDEXAUTH != 'N'  
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS,  
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'INSERT' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.INSERTAUTH != 'N'  
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS,  
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'REF' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.REFAUTH != 'N'  
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS, 
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE,
	   'SELECT' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.SELECTAUTH != 'N'  
UNION ALL
SELECT sp.DB_CMDB_NAME, sp.GRANTEE, sp.SNAP_TS,  
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'UPDATE' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_TABAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.UPDATEAUTH != 'N'
),
schperm as (
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'ALTERIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.ALTERINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'CREATEIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.CREATEINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'DROPIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.DROPINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'SELECTIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.SELECTINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'INSERTIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.INSERTINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE,  sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'UPDATEIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.UPDATEINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'DELETEIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.DELETEINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE,  sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'EXECUTEIN' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.EXECUTEINAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'SCHEMAADM' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.SCHEMAADMAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'ACCESSCTRL' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.ACCESSCTRLAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'DATAACCESS' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.DATAACCESSAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'LOAD' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.LOADAUTH != 'N'
UNION ALL
SELECT DB_CMDB_NAME, GRANTEE, sp.SNAP_TS,
	   CASE GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'SCHEMARCAC' PRIVILAGENAME, 'SCHEMA' TABLE_TYPE, sp.SCHEMANAME, '*' OBJECTNAME, '*' COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_SCHEMAAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
     AND sp.SCHEMARCACAUTH != 'N'
),
colperm as (
SELECT sp. DB_CMDB_NAME, sp.GRANTEE, sp.TIMESTAMP SNAP_TS,
	   CASE sp.GRANTEETYPE 	WHEN 'R' THEN 'DATABASE_ROLE'
	   				    	WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   'SELECT' PRIVILAGENAME, 
	   'TABLE' TABLE_TYPE, 
	   sp.TABSCHEMA SCHEMANAME, 
	   sp.TABNAME OBJECTNAME,
	   sp.COLNAME COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_COLAUTH sp
WHERE trim(sp.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
     AND VARCHAR_FORMAT(sp.TIMESTAMP,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
)
 SELECT rol.GRANTEE USERNAME, 
		CASE rol.GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
		 				    WHEN 'U' THEN 'DATABASE_USER'
		ELSE NULL END USERTYPE, 
		rol.ROLENAME,
		'GRANT' ACCESSTYPE,
		dbperm.PRIVILAGENAME,
		dbperm.TABLE_TYPE,
		dbperm.SCHEMANAME,
		dbperm.OBJECTNAME,
		dbperm.COLUMNNAME
 FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLEAUTH rol
  INNER JOIN dbperm  
   ON trim(rol.DB_CMDB_NAME) = trim(dbperm.DB_CMDB_NAME)
   		AND rol.SNAP_TS = dbperm.SNAP_TS
   		AND (rol.GRANTEE = dbperm.GRANTEE OR rol.ROLENAME  = dbperm.GRANTEE)
 WHERE trim(rol.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
    AND VARCHAR_FORMAT(rol.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)  
    AND TRIM(P_PERSONROLE) != 'DataSteward'
 UNION ALL
 SELECT rol.GRANTEE USERNAME, 
	   CASE rol.GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   rol.ROLENAME,
	   'GRANT' ACCESSTYPE,
	   tabperm.PRIVILAGENAME,
	   tabperm.TABLE_TYPE,
	   tabperm.SCHEMANAME,
	   tabperm.OBJECTNAME,
	   tabperm.COLUMNNAME
 FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLEAUTH rol
 INNER JOIN tabperm  
   ON trim(rol.DB_CMDB_NAME) = trim(tabperm.DB_CMDB_NAME)
   		AND rol.SNAP_TS = tabperm.SNAP_TS
   		AND (rol.GRANTEE = tabperm.GRANTEE OR rol.ROLENAME  = tabperm.GRANTEE)
 WHERE trim(rol.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
    AND VARCHAR_FORMAT(rol.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)  
    AND TRIM(P_PERSONROLE) != 'DataSteward'
 UNION ALL
  SELECT rol.GRANTEE USERNAME, 
	   CASE rol.GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   rol.ROLENAME,
	   'GRANT' ACCESSTYPE,
	   schperm.PRIVILAGENAME,
	   schperm.TABLE_TYPE,
	   schperm.SCHEMANAME,
	   schperm.OBJECTNAME,
	   schperm.COLUMNNAME
 FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLEAUTH rol
 INNER JOIN schperm  
   ON trim(rol.DB_CMDB_NAME) = trim(schperm.DB_CMDB_NAME)
   		AND rol.SNAP_TS = schperm.SNAP_TS
   		AND (rol.GRANTEE = schperm.GRANTEE OR rol.ROLENAME  = schperm.GRANTEE)
 WHERE trim(rol.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
    AND VARCHAR_FORMAT(rol.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
    AND TRIM(P_PERSONROLE) != 'DataSteward'
UNION ALL
SELECT rol.GRANTEE USERNAME, 
	   CASE rol.GRANTEETYPE WHEN 'R' THEN 'DATABASE_ROLE'
	   				    WHEN 'U' THEN 'DATABASE_USER'
	   ELSE NULL END USERTYPE, 
	   rol.ROLENAME,
	   'GRANT' ACCESSTYPE,
	   colperm.PRIVILAGENAME,
	   colperm.TABLE_TYPE,
	   colperm.SCHEMANAME,
	   colperm.OBJECTNAME,
	   ISNULL(colperm.COLUMNNAME,'*') COLUMNNAME
FROM AUTH_REPORT.VW_REPORT_DB2_LUW_ROLEAUTH rol
INNER JOIN colperm  
	ON trim(rol.DB_CMDB_NAME) = trim(colperm.DB_CMDB_NAME)
   		AND rol.SNAP_TS = colperm.SNAP_TS
   		AND (rol.GRANTEE = colperm.GRANTEE OR rol.ROLENAME  = colperm.GRANTEE)
WHERE trim(rol.DB_CMDB_NAME) = trim(P_DB_CMDB_NAME)
    AND VARCHAR_FORMAT(rol.SNAP_TS,'DD.MM.YYYY HH24:MI:SS') = TRIM(P_PREVTIMESTAMP)
    AND TRIM(P_PERSONROLE) != 'DataSteward'
 ORDER BY COLUMNNAME DESC
    )
    SELECT DISTINCT 
            'Global permission' Global, 
            ISNULL(curr.USERNAME, prev.USERNAME)			            	as username, 
            ISNULL(curr.ROLENAME, prev.ROLENAME)							as rolename,
            ISNULL(curr.SCHEMANAME, prev.SCHEMANAME)						as schemaname,
            ISNULL(curr.TABLE_TYPE, prev.TABLE_TYPE)				    	as table_type,		
            case ISNULL(curr.USERTYPE, prev.USERTYPE)	when 'U' then 'DATABASE_USER'
                                                    	when 'R' then 'DATABASE_ROLE'
            else ISNULL(curr.USERTYPE, prev.USERTYPE) end              	as usertype,
            ISNULL(curr.ACCESSTYPE, prev.ACCESSTYPE)						as AccessType,
            ISNULL(curr.PRIVILAGENAME, prev.PRIVILAGENAME)		    		as Privilege,
            ISNULL(curr.OBJECTNAME, prev.OBJECTNAME)				    	as Objectname,
            ISNULL(curr.COLUMNNAME, prev.COLUMNNAME)						as ColumnName,
            case when curr.PRIVILAGENAME is null and prev.PRIVILAGENAME is not null then 'DEL'
                 when prev.PRIVILAGENAME is null and curr.PRIVILAGENAME is not null then 'NEW'
            else 'SAME' end sign_compare
        FROM curr_global curr
        FULL OUTER JOIN prev_global prev 
            ON ISNULL(prev.USERNAME,'')=ISNULL(curr.USERNAME,'') 
            	AND ISNULL(prev.ROLENAME,'')=ISNULL(curr.ROLENAME,'') 
            	AND ISNULL(prev.SCHEMANAME,'')=ISNULL(curr.SCHEMANAME,'') 
            	AND ISNULL(prev.TABLE_TYPE,'')=ISNULL(curr.TABLE_TYPE,'') 
            	AND ISNULL(prev.OBJECTNAME,'')=ISNULL(curr.OBJECTNAME,'')
            	AND ISNULL(prev.COLUMNNAME,'')=ISNULL(curr.COLUMNNAME,'')
            	AND ISNULL(prev.USERTYPE,'')=ISNULL(curr.USERTYPE,'') 
            	and ISNULL(prev.ACCESSTYPE,'')=ISNULL(curr.ACCESSTYPE,'') 
            	and ISNULL(prev.PRIVILAGENAME,'')=ISNULL(curr.PRIVILAGENAME,'')
        WHERE curr.PRIVILAGENAME is null --without DELETED permission
    UNION ALL
    SELECT DISTINCT 
            'Global permission' Global, 
            ISNULL(curr.USERNAME, prev.USERNAME)			            	as username, 
            ISNULL(curr.ROLENAME, prev.ROLENAME)							as rolename,
            ISNULL(curr.SCHEMANAME, prev.SCHEMANAME)						as schemaname,
            ISNULL(curr.TABLE_TYPE, prev.TABLE_TYPE)				    	as table_type,		
            case ISNULL(curr.USERTYPE, prev.USERTYPE)	when 'U' then 'DATABASE_USER'
                                                    	when 'R' then 'DATABASE_ROLE'
            else ISNULL(curr.USERTYPE, prev.USERTYPE) end              	as usertype,
            ISNULL(curr.ACCESSTYPE, prev.ACCESSTYPE)						as AccessType,
            ISNULL(curr.PRIVILAGENAME, prev.PRIVILAGENAME)		    		as Privilege,
            ISNULL(curr.OBJECTNAME, prev.OBJECTNAME)				    	as Objectname,
            ISNULL(curr.COLUMNNAME, prev.COLUMNNAME)						as ColumnName,
            case when curr.PRIVILAGENAME is null and prev.PRIVILAGENAME is not null then 'DEL'
                 when prev.PRIVILAGENAME is null and curr.PRIVILAGENAME is not null then 'NEW'
            else 'SAME' end sign_compare
        FROM curr_object curr
        FULL OUTER JOIN prev_object prev 
            ON ISNULL(prev.USERNAME,'')=ISNULL(curr.USERNAME,'') 
            	AND ISNULL(prev.ROLENAME,'')=ISNULL(curr.ROLENAME,'') 
            	AND ISNULL(prev.SCHEMANAME,'')=ISNULL(curr.SCHEMANAME,'') 
            	AND ISNULL(prev.TABLE_TYPE,'')=ISNULL(curr.TABLE_TYPE,'') 
            	AND ISNULL(prev.OBJECTNAME,'')=ISNULL(curr.OBJECTNAME,'')
            	AND ISNULL(prev.COLUMNNAME,'')=ISNULL(curr.COLUMNNAME,'')
            	AND ISNULL(prev.USERTYPE,'')=ISNULL(curr.USERTYPE,'') 
            	and ISNULL(prev.ACCESSTYPE,'')=ISNULL(curr.ACCESSTYPE,'') 
            	and ISNULL(prev.PRIVILAGENAME,'')=ISNULL(curr.PRIVILAGENAME,'')
        WHERE curr.PRIVILAGENAME is null --without DELETED permission
        ORDER BY sign_compare, --strFullInstanceName, 
        username, rolename, table_type, AccessType, Privilege, schemaname, Objectname, ColumnName;
        OPEN cur;
END @

--
-- Optional: grant the procedure privilege
--
-- GRANT EXECUTE ON PROCEDURE { procedure-name }
--   TO { [ USER | GROUP | ROLE ] { grantee-name } } | PUBLIC @