CREATE OR REPLACE PROCEDURE AUTH_DB2_ZOS_REPORT.USP_SACHGEBIET_PARA (
    IN P_DB_CMDB_NAME	VARCHAR(100),
    IN P_ZUST_ORGA	VARCHAR(50) 
    , IN P_USERID VARCHAR(20))
  SPECIFIC USP_SACHGEBIET_PARA
  DYNAMIC RESULT SETS 1
  LANGUAGE SQL
  NOT DETERMINISTIC
  EXTERNAL ACTION
  MODIFIES SQL DATA
  CALLED ON NULL INPUT
  INHERIT SPECIAL REGISTERS
  OLD SAVEPOINT LEVEL
BEGIN 
  DECLARE cur CURSOR WITH RETURN FOR
  
--SELECT SACHGEBIET_CMDB_NAME AS SACHGEBIET_NAME, SACHGEBIET
--FROM AUTH_DB2_ZOS_REPORT.VW_REPORT_DB2_ZOS_TABAUTH
--WHERE SYSPLEX_CMDB_NAME = P_DB_CMDB_NAME		
--		AND ZUST_ORGA = P_ZUST_ORGA
--GROUP BY SACHGEBIET_CMDB_NAME, SACHGEBIET
--ORDER BY SACHGEBIET_CMDB_NAME;

SELECT 
SACHGEBIET_CMDB_NAME AS SACHGEBIET_NAME, SACHGEBIET
FROM AUTH_DB2_ZOS_REPORT.VW_AUTH_DB2_ZOS_SACHGEBIET AS S
WHERE STATE != 'AB' 
AND S.R_GROUP = P_ZUST_ORGA
AND (
--R_GROUP = MSSQL.UDF_GET_ORGA_BY_USER(P_USERID) OR  
1 = (SELECT 1 FROM AUTH_DB2_ZOS_REPORT.VW_DB2_ZOS_ADMINS WHERE USERID IN (P_USERID, 'LAN\' || P_USERID) FETCH FIRST 1 ROW ONLY) OR
S.DATA_ENABLER_1 = P_USERID OR
		S.DATA_ENABLER_2 = P_USERID OR
		S.DATA_ENABLER_3 = P_USERID OR
		S.DATA_OWNER = P_USERID OR
		S.DATA_STEWARD_1 = P_USERID OR
		S.DATA_STEWARD_2 = P_USERID OR
		S.DATA_STEWARD_3 = P_USERID
    )
GROUP BY SACHGEBIET_CMDB_NAME, SACHGEBIET
ORDER BY SACHGEBIET_CMDB_NAME;
 		
   SET P_USERID = UPPER(P_USERID);
   IF (SELECT INSTR(P_USERID,'LAN\') FROM SYSIBM.SYSDUMMY1) > 0
 THEN
   SET P_USERID = SUBSTRING(UPPER(P_USERID),5); -- CUT 'LAN\' FROM USERID
 ELSE
    SET P_USERID = UPPER(P_USERID);
 END IF;

 
-- 	SELECT DISTINCT ISNULL(sg.sachgebiet,s.sachgebiet)  AS SACHGEBIET_NAME, 
-- 					s.sachgebiet
--	FROM AUTH_DB2_ZOS_REPORT.VW_REPORT_DB2_ZOS_TABAUTH s
--	LEFT JOIN 	(SELECT  t.HOSTLOESCHEN, RPAD(SUBSTRING(LISTAGG(TRIM(t.name),','),1,41)
--	                                         ,case when 41-LENGTH(LISTAGG(TRIM(t.name),',')) < LENGTH(LISTAGG(TRIM(t.name),',')) then LENGTH(LISTAGG(TRIM(t.name),',')) 
--											   else  41-LENGTH(LISTAGG(TRIM(t.name),',')) end )
--											   as SACHGEBIET 
--				FROM AUTH_DB2_ZOS_REPORT.VW_REPORT_DB2_ZOS_TAVERASACHGEBIET t  
--				GROUP BY t.HOSTLOESCHEN) sg
--		ON sg.HOSTLOESCHEN=s.sachgebiet
--	WHERE s.SYSPLEX_CMDB_NAME = P_DB_CMDB_NAME		
--		AND s.zust_orga = P_ZUST_ORGA
--	ORDER BY 1;
		
	OPEN cur;
END
